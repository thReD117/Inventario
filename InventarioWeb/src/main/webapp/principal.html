<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Principal</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="styleP.css">
</head>
<body>
    <div class="contenedor">
        <div class="filtrados">
            <div class="logo"></div>
            <h3>FILTRAR POR:</h3>
            <div class="filtrado-interno">
                <button class="boton1">ID GRUPAL</button>
                <button class="boton2">ID INDIVIDUAL</button>
            </div>
            <button class="agregar"><i class="fa-solid fa-plus"></i></button>
            <button class="borrar"><i class="fa-solid fa-trash-can"></i></button>
            <button class="limpiar"><i class="fa-solid fa-broom"></i></button> <a href="index.html">
                <button class="regresar">
                    <i class="fa-solid fa-circle-left"></i>
                </button>
            </a>
        </div>
        <div class="form">
            <div class="formato">
                <input type="text" class="box" placeholder="Buscar prenda...">
                <button class="buscar">
                    <i class="fa-solid fa-magnifying-glass"></i>
                </button>
                <button class="imprimir">
                    <i class="fa-solid fa-print"></i>
                </button>
            </div>
        </div>
        <div id="modalImprimir" class="modal">
            <div class="modal-content">
                <p>¿Desea imprimir todo el contenido?</p>
                <div class="modal-buttons">
                    <button id="botonImprimirModal">Imprimir</button>
                    <button id="botonCancelarModal">Cancelar</button>
                </div>
            </div>
        </div>
        <div id="modalAgregar" class="modal">
            <div class="modal-content">
                <h3>Agregar Elemento</h3>
                <form id="formularioAgregar">
                    <label for="tipo">Tipo:</label>
                    <select id="tipo" name="CATEGORY" required>
                        <option value="" selected disabled hidden>Selecciona una opción</option>
                        <option value="SUPERIOR">Superior</option>
                        <option value="LOWER">Inferior</option>
                        <option value="INTERIOR">Interior</option>
                        <option value="ACCESSORIES">Accesorio</option>
                    </select><br><br>

                    <label for="categoria">Categoría:</label>
                    <select id="categoria" name="CATEGORY_ENUM" required>
                        </select><br><br>
                    <label for="talla">Talla:</label>
                    <input type="text" id="talla" name="SIZE" required><br><br>
                    <label for="material">Material:</label>
                    <input type="text" id="material" name="MATERIAL" required><br><br>
                    <label for="color">Color:</label>
                    <input type="text" id="color" name="COLOR" required><br><br>
                    <label for="descripcion">Descripción:</label>
                    <input type="text" id="descripcion" name="DESCRIPTION" required><br><br>
                    <label for="precio">Precio:</label>
                    <input type="text" id="precio" name="PRICE" required><br><br>
                    <label for="temporada">Temporada:</label>
                    <select id="temporada" name="SEASON" required>
                        <option value="SPRING">Primavera</option>
                        <option value="SUMMER">Verano</option>
                        <option value="AUTUMN">Otoño</option>
                        <option value="WINTER">Invierno</option>
                        <option value="NA">No aplica</option>
                    </select><br><br>
                    <label for="genero">Género:</label>
                    <select id="genero" name="GENDER" required>
                        <option value="MEN">Masculino</option>
                        <option value="WOMEN">Femenino</option>
                        <option value="UNISEX">Unisex</option>
                    </select><br><br>
                    <label for="precio">Cantidad:</label>
                    <input type="number" id="cantidad" name="QUANTITY" required><br><br>
                    <div class="modal-buttons">
                        <button type="submit" id="botonAgregarModal">Agregar</button>
                        <button type="button" id="botonCancelarAgregar">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="modalBorrar" class="modal">
            <div class="modal-content">
                <h3>Borrar Elemento</h3>
                <p>Ingrese el ID INDIVIDUAL del elemento que desea borrar:</p>
                <input type="number" id="idBorrar">
                <div class="modal-buttons">
                    <button type="button" id="botonBorrarModal">Borrar</button>
                    <button type="button" id="botonCancelarBorrar">Cancelar</button>
                </div>
            </div>
        </div>

        <div id="modalLimpiarGrupo" class="modal">
            <div class="modal-content">
                <h3>Limpiar Grupo</h3>
                <p>Ingrese el ID GRUPAL del grupo que desea limpiar:</p>
                <input type="text" id="groupIdLimpiar" placeholder="Ej: GRP_001">
                <div class="modal-buttons">
                    <button type="button" id="botonLimpiarGrupoModal">Limpiar</button>
                    <button type="button" id="botonCancelarLimpiarGrupo">Cancelar</button>
                </div>
            </div>
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', function() {
                // Modal de Imprimir
                const botonImprimirPrincipal = document.querySelector('.imprimir');
                const modalImprimir = document.getElementById('modalImprimir');
                const botonImprimirModal = document.getElementById('botonImprimirModal');
                const botonCancelarModalImprimir = document.getElementById('botonCancelarModal');

                botonImprimirPrincipal.addEventListener('click', () => modalImprimir.style.display = "block");
                botonImprimirModal.addEventListener('click', () => {
                    // Abre el servlet que genera el PDF en una nueva pestaña
                    window.open('GeneratePdfServlet', '_blank');
                    modalImprimir.style.display = "none";
                });

                botonCancelarModalImprimir.addEventListener('click', () => modalImprimir.style.display = "none");
                window.addEventListener('click', (event) => { if (event.target == modalImprimir) modalImprimir.style.display = "none"; });

                // Modal de Agregar
                const botonAgregarPrincipal = document.querySelector('.agregar');
                const modalAgregar = document.getElementById('modalAgregar');
                const botonAgregarModal = document.getElementById('botonAgregarModal');
                const botonCancelarAgregar = document.getElementById('botonCancelarAgregar');
                const formularioAgregar = document.getElementById('formularioAgregar');

                botonAgregarPrincipal.addEventListener('click', () => modalAgregar.style.display = "block");
                botonCancelarAgregar.addEventListener('click', () => modalAgregar.style.display = "none");
                window.addEventListener('click', (event) => { if (event.target == modalAgregar) modalAgregar.style.display = "none"; });

                // Modal de Borrar
                const botonBorrarPrincipal = document.querySelector('.borrar');
                const modalBorrar = document.getElementById('modalBorrar');
                const botonBorrarModal.addEventListener('click', () => {
                const idABorrar = parseInt(inputIdBorrar.value);
                if (!idABorrar) {
                    alert("Ingresa un ID válido.");
                    return;
                }
            
                fetch(`DeleteClothingServlet?id=${idABorrar}`, {
                    method: 'POST'  // o 'POST' según tu servlet
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Error al borrar el elemento.");
                    }
                    return response.text();  // o json, según lo que devuelvas
                })
                .then(data => {
                    alert(`Elemento con ID ${idABorrar} borrado correctamente.`);
                    modalBorrar.style.display = "none";
                    inputIdBorrar.value = '';
                    renderizarTabla();  // para actualizar la tabla luego del borrado
                })
                .catch(error => {
                    alert("No se pudo borrar: " + error.message);
                });
            });
                const botonCancelarBorrar = document.getElementById('botonCancelarBorrar');
                const inputIdBorrar = document.getElementById('idBorrar');

                botonBorrarPrincipal.addEventListener('click', () => modalBorrar.style.display = "block");
                botonCancelarBorrar.addEventListener('click', () => modalBorrar.style.display = "none");
                window.addEventListener('click', (event) => { if (event.target == modalBorrar) modalBorrar.style.display = "none"; });

                // --- Nuevo Modal para Limpiar Grupo ---
                const botonLimpiarPrincipal = document.querySelector('.limpiar');
                const modalLimpiarGrupo = document.getElementById('modalLimpiarGrupo');
                const botonLimpiarGrupoModal = document.getElementById('botonLimpiarGrupoModal');
                const botonCancelarLimpiarGrupo = document.getElementById('botonCancelarLimpiarGrupo');
                const inputGroupIdLimpiar = document.getElementById('groupIdLimpiar'); // El nuevo input

                botonLimpiarPrincipal.addEventListener('click', () => modalLimpiarGrupo.style.display = "block");
                botonCancelarLimpiarGrupo.addEventListener('click', () => modalLimpiarGrupo.style.display = "none");
                window.addEventListener('click', (event) => { if (event.target == modalLimpiarGrupo) modalLimpiarGrupo.style.display = "none"; });

                // Lógica al presionar "Limpiar" dentro del modal de limpiar grupo
                botonLimpiarGrupoModal.addEventListener('click', () => {
                    const groupId = inputGroupIdLimpiar.value;

                    if (groupId.trim() === '') {
                        alert("Por favor, ingrese el ID GRUPAL.");
                        return;
                    }

                    // Prepara los datos del formulario directamente
                    const formData = new URLSearchParams();
                    formData.append('groupId', groupId); // Añade el groupId como un parámetro de formulario

                    fetch('ClearGroupServlet', {
                        method: 'POST',
                        headers: {
                            // Este Content-Type es crucial para enviar datos de formulario
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: formData.toString() // Convierte los parámetros a una cadena URL-codificada
                    })
                    .then(response => {
                        if (!response.ok) {
                            // Si la respuesta no es 2xx, intenta leer el error del servidor como JSON
                            return response.json().then(err => Promise.reject(err));
                        }
                        // Si la respuesta fue exitosa, la procesa como JSON
                        return response.json();
                    })
                    .then(data => {
                        if (data.status === 'success') {
                            alert(data.message);
                            renderizarTabla(); // Vuelve a cargar la tabla para reflejar los cambios
                        } else {
                            alert("Error al limpiar grupo: " + data.message);
                        }
                        inputGroupIdLimpiar.value = ''; // Limpia el input
                        modalLimpiarGrupo.style.display = "none"; // Cierra el modal
                    })
                    .catch(error => {
                        console.error('Error en la solicitud:', error);
                        alert(`Hubo un problema al limpiar el grupo. Detalles: ${error.message || 'Error de red/servidor'}`);
                        inputGroupIdLimpiar.value = ''; // Limpia el input incluso si hay error
                        modalLimpiarGrupo.style.display = "none"; // Cierra el modal
                    });
                });
                // --- Fin del nuevo Modal para Limpiar Grupo ---

                const tablaBody = document.querySelector('.table-bordered tbody');
                const fieldOrder = ["idCompleta", "idIndividual", "idGrupal", "tipo", "categoria", "talla", "material",
                                    "color", "descripcion", "precio", "temporada", "genero"];

                function insertarFila(item){
                    const nuevaFila = tablaBody.insertRow();
                    fieldOrder.forEach(field => {
                       const nuevaCelda = nuevaFila.insertCell();
                       nuevaCelda.textContent = item[field];
                    });
                }

                function renderizarTabla() {
                    tablaBody.innerHTML = '';

                    // Recupera los datos de la tabla mediante el servlet
                    fetch('ShowClothingsServlet')
                            .then(response => response.json())
                            .then(datosTabla => {
                                datosTabla.forEach(item => insertarFila(item));
                            })
                            .catch(error => console.error('Error loading data:', error));
                }
                renderizarTabla(); // Renderizar la tabla inicial

                // Envia los datos al servidor para agregar
                document.getElementById("formularioAgregar").addEventListener("submit", function(e) {
                    e.preventDefault();

                    const form = e.target;
                    const formData = new FormData(form);
                    form.reset();

                    fetch("AddClothingServlet",{
                                method: "POST",
                                body: formData
                            })
                            .then(response => {
                                if(!response.ok){
                                    throw new Error("Error al enviar el formulario");
                                }
                                return response.json();
                            })
                            .then(data => {
                                if(data.length === 0){
                                    alert("No se realizó la operación.");
                                    return;
                                }
                                alert("Operación realizada exitosamente.");
                                renderizarTabla(); // Re-renderiza la tabla después de agregar
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                alert("Hubo un error al agregar el elemento: " + error.message);
                            });
                });

                // Funcionalidad para borrar un elemento individual
                botonBorrarModal.addEventListener('click', () => {
                    const idABorrar = parseInt(inputIdBorrar.value);

                    if (isNaN(idABorrar)) {
                        alert("Por favor, ingrese un ID individual válido.");
                        return;
                    }

                    fetch(`DeleteClothingServlet?idIndividual=${idABorrar}`, {
                        method: 'DELETE'
                    })
                    .then(response => {
                        if (!response.ok) {
                            return response.text().then(text => { throw new Error(text); });
                        }
                        return response.text();
                    })
                    .then(message => {
                        alert(message);
                        renderizarTabla(); // Re-renderiza la tabla después de borrar
                        inputIdBorrar.value = '';
                        modalBorrar.style.display = "none";
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert(`No se pudo borrar el elemento: ${error.message}`);
                    });
                });
            });
        </script>
        <div class="tabla">
            <table class="table-bordered table-striped table-condensed table-fixed">
                <thead>
                    <tr>
                        <th>ID COMPLETA</th>
                        <th>ID INDIVIDUAL</th>
                        <th>ID DE GRUPAL</th>
                        <th>TIPO</th>
                        <th>CATEGORIA</th>
                        <th>TALLA</th>
                        <th>MATERIAL</th>
                        <th>COLOR</th>
                        <th>DESCRIPCION</th>
                        <th>PRECIO</th>
                        <th>TEMPORADA</th>
                        <th>GENERO</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>
    <script>
        // Llama al servlet para obtener todos los valores del enum del tipo correspondiente
        const categorySelect = document.getElementById("categoria");
        document.getElementById("tipo").addEventListener('change', function() {
            fetch('getEnumTypes?clothingType='+this.value)
                    .then(response => response.text())
                    .then(data => categorySelect.innerHTML = data)
        });
    </script>
</body>
</html>
